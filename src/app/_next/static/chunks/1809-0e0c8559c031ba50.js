"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1809],{71407:function(e,t,r){r.d(t,{r:function(){return g}});var a=r(61888);class i{get delete(){var e;return null===(e=this.cursor.delete)||void 0===e?void 0:e.bind(this.cursor)}get update(){var e;return null===(e=this.cursor.update)||void 0===e?void 0:e.bind(this.cursor)}[Symbol.asyncIterator](){return this.cursor[Symbol.asyncIterator]()}constructor(e){Object.defineProperty(this,"cursor",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"key",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"direction",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"request",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"primaryKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"advance",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"continue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"continuePrimaryKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.direction=e.direction,this.request=e.request,this.primaryKey=e.primaryKey,this.key=e.key,this.advance=e.advance.bind(e),this.continue=e.continue.bind(e),this.continuePrimaryKey=e.continuePrimaryKey.bind(e)}}class n extends i{[Symbol.asyncIterator](){return this.cursor[Symbol.asyncIterator]()}constructor(e){super(e),Object.defineProperty(this,"cursor",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e.value}}var s=function(e,t,r,a){return new(r||(r=Promise))(function(i,n){function s(e){try{c(a.next(e))}catch(e){n(e)}}function o(e){try{c(a.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):((t=e.value)instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((a=a.apply(e,t||[])).next())})};class o{get(e){return s(this,void 0,void 0,function*(){return this.index.get(e)})}getAll(e,t){return s(this,void 0,void 0,function*(){return this.index.getAll(e,t)})}getAllKeys(e,t){return s(this,void 0,void 0,function*(){return this.index.getAllKeys(e,t)})}getKey(e){return s(this,void 0,void 0,function*(){return this.index.getKey(e)})}count(e){return s(this,void 0,void 0,function*(){return this.index.count(e)})}openCursor(e,t){return s(this,void 0,void 0,function*(){let r=yield this.index.openCursor(e,t);return r&&new n(r)})}openKeyCursor(e,t){return s(this,void 0,void 0,function*(){let r=yield this.index.openKeyCursor(e,t);return r&&new i(r)})}[Symbol.asyncIterator](){return this.index[Symbol.asyncIterator]()}iterate(e,t){return this.index.iterate(e,t)}constructor(e){Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"keyPath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multiEntry",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"unique",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyPath=e.keyPath,this.multiEntry=e.multiEntry,this.name=e.name,this.unique=e.unique}}var c=function(e,t,r,a){return new(r||(r=Promise))(function(i,n){function s(e){try{c(a.next(e))}catch(e){n(e)}}function o(e){try{c(a.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):((t=e.value)instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((a=a.apply(e,t||[])).next())})};class l{get indexNames(){return this.objectStore.indexNames}get put(){var e;return null===(e=this.objectStore.put)||void 0===e?void 0:e.bind(this.objectStore)}get add(){var e;return null===(e=this.objectStore.add)||void 0===e?void 0:e.bind(this.objectStore)}get clear(){var e;return null===(e=this.objectStore.clear)||void 0===e?void 0:e.bind(this.objectStore)}get delete(){var e;return null===(e=this.objectStore.delete)||void 0===e?void 0:e.bind(this.objectStore)}createIndex(e,t,r){return this.objectStore.createIndex?new o(this.objectStore.createIndex(e,t,r)):null}deleteIndex(e){return this.objectStore.deleteIndex(e)}count(e){return c(this,void 0,void 0,function*(){return this.objectStore.count(e)})}get(e){return c(this,void 0,void 0,function*(){return this.objectStore.get(e)})}getAll(e,t){return c(this,void 0,void 0,function*(){return this.objectStore.getAll(e,t)})}getAllKeys(e,t){return c(this,void 0,void 0,function*(){return this.objectStore.getAllKeys(e,t)})}getKey(e){return c(this,void 0,void 0,function*(){return this.objectStore.getKey(e)})}index(e){return new o(this.objectStore.index(e))}openKeyCursor(e,t){return c(this,void 0,void 0,function*(){let r=yield this.objectStore.openKeyCursor(e,t);return r&&new i(r)})}openCursor(e,t){return c(this,void 0,void 0,function*(){let r=yield this.objectStore.openCursor(e,t);return r&&new n(r)})}iterate(e,t){return this.objectStore.iterate(e,t)}[Symbol.asyncIterator](){return this.objectStore[Symbol.asyncIterator]()}constructor(e){Object.defineProperty(this,"objectStore",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"autoIncrement",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyPath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.autoIncrement=e.autoIncrement,this.keyPath=e.keyPath,this.name=e.name}}class u{get error(){return this.transaction.error}get done(){return this.transaction.done}abort(){return this.transaction.abort()}commit(){return this.transaction.commit()}objectStore(e){return new l(this.transaction.objectStore(e))}addEventListener(e,t,r){return this.transaction.addEventListener(e,t,r)}removeEventListener(e,t,r){return this.transaction.removeEventListener(e,t,r)}set onabort(e){this.transaction.onabort=e}set onerror(e){this.transaction.onerror=e}set oncomplete(e){this.transaction.oncomplete=e}dispatchEvent(e){return this.transaction.dispatchEvent(e)}constructor(e){Object.defineProperty(this,"transaction",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"durability",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"objectStoreNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.durability=e.durability,this.mode=e.mode,this.objectStoreNames=e.objectStoreNames}}var d=function(e,t,r,a){return new(r||(r=Promise))(function(i,n){function s(e){try{c(a.next(e))}catch(e){n(e)}}function o(e){try{c(a.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):((t=e.value)instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((a=a.apply(e,t||[])).next())})};class h{get objectStoreNames(){return this.database.objectStoreNames}transaction(e,t,r){return new u(this.database.transaction(e,t,r))}createObjectStore(e,t){return new l(this.database.createObjectStore(e,t))}deleteObjectStore(e){return this.database.deleteObjectStore(e)}get(e,t){return d(this,void 0,void 0,function*(){return this.database.get(e,t)})}getAll(e,t,r){return d(this,void 0,void 0,function*(){return this.database.getAll(e,t,r)})}add(e,t,r){return d(this,void 0,void 0,function*(){return this.database.add(e,t,r)})}put(e,t,r){return d(this,void 0,void 0,function*(){return this.database.put(e,t,r)})}delete(e,t){return d(this,void 0,void 0,function*(){return this.database.delete(e,t)})}clear(e){return d(this,void 0,void 0,function*(){return this.database.clear(e)})}count(e,t){return d(this,void 0,void 0,function*(){return this.database.count(e,t)})}getKey(e,t){return d(this,void 0,void 0,function*(){return this.database.getKey(e,t)})}getAllKeys(e,t,r){return d(this,void 0,void 0,function*(){return this.database.getAllKeys(e,t,r)})}countFromIndex(e,t,r){return d(this,void 0,void 0,function*(){return this.database.countFromIndex(e,t,r)})}getFromIndex(e,t,r){return d(this,void 0,void 0,function*(){return this.database.getFromIndex(e,t,r)})}getAllFromIndex(e,t,r,a){return d(this,void 0,void 0,function*(){return this.database.getAllFromIndex(e,t,r,a)})}getAllKeysFromIndex(e,t,r,a){return d(this,void 0,void 0,function*(){return this.database.getAllKeysFromIndex(e,t,r,a)})}getKeyFromIndex(e,t,r){return d(this,void 0,void 0,function*(){return this.database.getKeyFromIndex(e,t,r)})}addEventListener(e,t,r){this.database.addEventListener(e,t,r)}removeEventListener(e,t,r){this.database.removeEventListener(e,t,r)}set onabort(e){this.database.onabort=e}set onclose(e){this.database.onclose=e}set onerror(e){this.database.onerror=e}set onversionchange(e){this.database.onversionchange=e}close(){return this.database.close()}dispatchEvent(e){return this.database.dispatchEvent(e)}constructor(e){Object.defineProperty(this,"database",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.version=e.version,this.name=e.name}}var v=function(e,t,r,a){return new(r||(r=Promise))(function(i,n){function s(e){try{c(a.next(e))}catch(e){n(e)}}function o(e){try{c(a.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):((t=e.value)instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((a=a.apply(e,t||[])).next())})};class g{openDB(e){let{onBlocked:t,onBlocking:r,onTerminated:i,onUpgrade:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return v(this,void 0,void 0,function*(){let s=yield(0,a.X3)(this.name,e,{blocked:t,blocking:r,terminated:i,upgrade:(e,t,r,a,i)=>{let s=new h(e);null==n||n(s,t,r,new u(a),i)}});return new h(s)})}deleteDB(e){let{onBlocked:t}=e;return v(this,void 0,void 0,function*(){yield(0,a.Lj)(this.name,{blocked:t})})}constructor(e){Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:e})}}},36301:function(e,t,r){r.d(t,{I:function(){return a},U:function(){return i}});let a=()=>Math.floor(Date.now()/1e3),i=async e=>{let{secretKey:t,data:r}=e,a=new TextEncoder,i=a.encode(t);return crypto.subtle.importKey("raw",i,{name:"HMAC",hash:{name:"SHA-256"}},!0,["sign","verify"]).then(async e=>{let t=a.encode(r);return crypto.subtle.sign("HMAC",e,t).then(e=>btoa(String.fromCharCode(...new Uint8Array(e))).slice(0,-1))})}},77900:function(e,t,r){var a,i;r.d(t,{n:function(){return a}}),(i=a||(a={})).LOSSLESS="lossless",i.HQ="hq",i.NQ="nq",i.LQ="lq",i.PREVIEW="preview",i.SMART_PREVIEW="smart_preview"},61605:function(e,t,r){var a,i;r.d(t,{J:function(){return a}}),(i=a||(a={})).RAW="raw",i.ENCRAW="encraw"},91809:function(e,t,r){r.d(t,{aV:function(){return k},aT:function(){return m},sb:function(){return A},Jc:function(){return f},Jt:function(){return eo},OF:function(){return eA},_s:function(){return b},Ju:function(){return eR},kU:function(){return eN}});var a,i,n,s,o,c,l,u,d,h,v,g,y,m,b,f,p,w=r(29397),S=r(32214);let T=e=>t=>t.id!==e||(t.stop(),!1);class k{injectTask(e){this.queue.push(e),this.startNextDownload()}removeTask(e){this.removeTaskFromQueue(e),this.removeTaskFromActiveDownloads(e)}startTask(e){this.activeTasks.push(e),e.start().finally(()=>{this.removeTaskFromActiveDownloads(e.id),this.startNextDownload()})}startNextDownload(){let e=this.activeTasks.length,t=this.variables.maxConcurrentDownloads-e;t>0&&this.queue.length>0&&this.queue.splice(0,t).forEach(this.startTask.bind(this))}removeTaskFromQueue(e){this.queue=this.queue.filter(T(e))}removeTaskFromActiveDownloads(e){this.activeTasks=this.activeTasks.filter(T(e))}constructor(e){(0,w._)(this,"variables",void 0),(0,w._)(this,"events",new S.Q),(0,w._)(this,"queue",[]),(0,w._)(this,"activeTasks",[]),this.variables=e.variables}}class A{download(e){e.forEach(e=>{this.tracks.download(e)})}stopDownload(e){e.forEach(e=>{this.tracks.stopDownload(e)})}delete(e){e.forEach(e=>{this.tracks.deleteTrack(e)})}constructor(e){(0,w._)(this,"tracks",void 0),this.tracks=e.tracks}}let E=()=>"undefined"==typeof navigator?{isOffline:!1}:{isOffline:!navigator.onLine};class I{updateStatus(e){this.status=E(),e(this.status)}subscribe(e){this.updateStatus(e),window.addEventListener("online",this.updateStatus.bind(this,e)),window.addEventListener("offline",this.updateStatus.bind(this,e))}unsubscribe(e){window.removeEventListener("online",this.updateStatus.bind(this,e)),window.removeEventListener("offline",this.updateStatus.bind(this,e))}constructor(){(0,w._)(this,"status",E())}}var C=r(4106);(a=d||(d={})).DEFAULT="E_FILE_STORAGE",a.NOT_AVAILABLE="E_FILE_STORAGE_NOT_AVAILABLE",a.INVALID_PATH="E_FILE_STORAGE_INVALID_PATH";class D extends C.y{constructor(e="File storage error",{code:t=d.DEFAULT,...r}={}){super(e,{code:t,...r}),(0,w._)(this,"name","FileStorageException"),Object.setPrototypeOf(this,D.prototype)}}class _{async getRootDir(){if(!this.isAvailable||!this.rootDir)throw new D("FileStorage is not available",{code:d.NOT_AVAILABLE});return this.rootDir}parsePath(e){let t=e.split("/"),r=t.pop();if(!r)throw new D("Invalid file path",{code:d.INVALID_PATH,data:{path:e}});return{name:r,dir:t.join("/")}}async getDirectoryRecursive(e,t,r){let a=t.shift();if(!a)return e;let i=await e.getDirectoryHandle(a,r);return this.getDirectoryRecursive(i,t,r)}async getDirectory(e,t){let r=e.split("/"),a=await this.getRootDir();return this.getDirectoryRecursive(a,r,t)}async getFile(e,t){let{name:r,dir:a}=this.parsePath(e);return(await this.getDirectory(a,t)).getFileHandle(r,t)}async writeFile(e,t){try{let r=await this.getFile(e,{create:!0}),a=await r.createWritable();await a.write(t),await a.close()}catch(r){("string"==typeof r||r instanceof Error)&&this.logger.error(r,{message:"Error write file",data:{path:e,data:t}})}}async appendFile(e,t){try{let r=await this.getFile(e,{create:!0}),[a,i]=await Promise.all([r.getFile(),r.createWritable({keepExistingData:!0})]);await i.write({type:"write",position:a.size,data:t}),await i.close()}catch(r){("string"==typeof r||r instanceof Error)&&this.logger.error(r,{message:"Error append file",data:{path:e,data:t}})}}async readFile(e){return(await this.getFile(e)).getFile()}async deleteFile(e,t){try{let{name:r,dir:a}=this.parsePath(e),i=await this.getDirectory(a);return await i.removeEntry(r,t)}catch(r){("string"==typeof r||r instanceof Error)&&this.logger.error(r,{message:"Error delete file",data:{path:e,options:t}})}}async createFileURL(e){let t=await this.getFile(e),r=await t.getFile();return URL.createObjectURL(r)}revokeFileURL(e){URL.revokeObjectURL(e)}async clearAll(){let e=await this.getRootDir();for await(let t of e.values())e.removeEntry(t.name,{recursive:!0})}async logDirectoryTree(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";for await(let r of e.values())if("directory"===r.kind)console.log("".concat(t,"\uD83D\uDCC1 ").concat(r.name)),await this.logDirectoryTree(r,"".concat(t,"  "));else if("file"===r.kind){let e=await r.getFile();console.log("".concat(t,"\uD83D\uDCC4 ").concat(r.name," ").concat(e.size," bytes"))}}constructor({logger:e}){(0,w._)(this,"rootDir",void 0),(0,w._)(this,"isAvailable",!0),(0,w._)(this,"logger",void 0),this.logger=e;try{this.rootDir=window.navigator.storage.getDirectory()}catch(e){("string"==typeof e||e instanceof Error)&&this.logger.error(e,{message:"FileStorage is not available"}),this.isAvailable=!1}}}var R=r(71407);(h||(h={})).DEFAULT="E_IDB_STORE";class O extends C.y{constructor(e="Idb store error",{code:t=h.DEFAULT,...r}={}){super(e,{code:t,...r}),(0,w._)(this,"name","IdbStoreException"),Object.setPrototypeOf(this,O.prototype)}}class x{async clearAll(){return this.executeTransaction(async e=>e.clear(this.config.name))}async executeTransaction(e){let t=await this.idb;if(!this.isIdbAvailable||!t)throw new O("IdbStore is not available");return e(t)}async openIdb(){return new R.r("".concat("music_slam","_").concat(this.config.name)).openDB(this.config.version,{onBlocked:(e,t,r)=>{var a,i;this.onError(),null===(i=this.handlers)||void 0===i||null===(a=i.onBlocked)||void 0===a||a.call(i,e,t,r)},onBlocking:(e,t,r)=>{var a,i;this.onError(),null===(i=this.handlers)||void 0===i||null===(a=i.onBlocking)||void 0===a||a.call(i,e,t,r)},onTerminated:()=>{var e,t;this.onError(),null===(t=this.handlers)||void 0===t||null===(e=t.onTerminated)||void 0===e||e.call(t)},onUpgrade:(e,t,r,a,i)=>{var n,s;null===(s=this.handlers)||void 0===s||null===(n=s.onUpgrade)||void 0===n||n.call(s,e,t,r,a,i)}})}async onError(){await this.closeConnection(),this.attemptsConnection<this.config.restrictions.attemptsCount?(this.attemptsConnection++,this.idb=this.openIdb()):this.isIdbAvailable=!1}async closeConnection(){try{let e=await this.idb;e&&e.close()}catch(e){("string"==typeof e||e instanceof Error)&&this.logger.error(e,{message:"Error while closing connection"})}}constructor({config:e,logger:t,handlers:r}){(0,w._)(this,"idb",void 0),(0,w._)(this,"config",void 0),(0,w._)(this,"handlers",void 0),(0,w._)(this,"attemptsConnection",0),(0,w._)(this,"isIdbAvailable",!0),(0,w._)(this,"logger",void 0),this.config=e,this.logger=t,this.handlers=r,this.idb=this.openIdb()}}(i=v||(v={})).RESPONSE_CACHE="response_cache",i.TRACKS="tracks",i.ALBUMS="albums",i.ALBUMS_TRACKS="albums_tracks",i.ARTISTS="artists",i.ARTISTS_TRACKS="artists_tracks",i.USERS="users",i.USERS_TRACKS="users_tracks";let F={name:v.ALBUMS,version:1,restrictions:{attemptsCount:3,count:100}};class L extends x{async put(e){return this.executeTransaction(async t=>{var r;let a=await t.get(F.name,String(e.id)),i=Date.now(),n=null!==(r=null==a?void 0:a.createdAt)&&void 0!==r?r:i;return t.put(F.name,{meta:e,updatedAt:i,createdAt:n},String(e.id))}).catch(t=>{this.logger.error(t,{message:"AlbumsStore put",data:{albumId:e.id}})})}async get(e){return this.executeTransaction(async t=>{var r;let a=await t.get(F.name,e);return null!==(r=null==a?void 0:a.meta)&&void 0!==r?r:null}).catch(t=>(this.logger.error(t,{message:"AlbumsStore get",data:{albumId:e}}),null))}async delete(e){return this.executeTransaction(async t=>t.delete(F.name,e)).catch(t=>{this.logger.error(t,{message:"AlbumsStore delete",data:{albumId:e}})})}constructor({logger:e}){super({config:F,logger:e,handlers:{onUpgrade:e=>{e.createObjectStore(F.name)}}})}}let P={name:v.ALBUMS_TRACKS,version:1,restrictions:{attemptsCount:3}},j="albumId",U="trackId",N=(e,t)=>"".concat(e,":").concat(t);class K extends x{async put(e,t){return this.executeTransaction(async r=>r.put(P.name,{trackId:e,albumId:t},N(e,t))).catch(r=>{this.logger.error(r,{message:"AlbumsTracksStore put",data:{trackId:e,albumId:t}})})}async getTracksByAlbumId(e){return this.executeTransaction(async t=>(await t.getAllFromIndex(P.name,j,e)).map(e=>e.trackId)).catch(t=>{this.logger.error(t,{message:"AlbumsTracksStore getTracksByAlbumId",data:{albumId:e}})})}async getAlbumsByTrackId(e){return this.executeTransaction(async t=>(await t.getAllFromIndex(P.name,U,e)).map(e=>e.albumId)).catch(t=>{this.logger.error(t,{message:"AlbumsTracksStore getAlbumsByTrackId",data:{trackId:e}})})}async delete(e,t){return this.executeTransaction(async r=>r.delete(P.name,N(e,t))).catch(e=>{this.logger.error(e,{message:"AlbumsTracksStore delete"})})}async getCountByAlbum(e){return this.executeTransaction(async t=>t.countFromIndex(P.name,j,e)).catch(t=>{this.logger.error(t,{message:"AlbumsTracksStore getCountByAlbum",data:{albumId:e}})})}constructor({logger:e}){super({config:P,logger:e,handlers:{onUpgrade:e=>{let t=e.createObjectStore(P.name);t.createIndex(j,"albumId"),t.createIndex(U,"trackId")}}})}}let B={name:v.ARTISTS,version:1,restrictions:{attemptsCount:3,count:100}};class M extends x{async put(e){return this.executeTransaction(async t=>{var r;let a=await t.get(B.name,String(e.id)),i=Date.now(),n=null!==(r=null==a?void 0:a.createdAt)&&void 0!==r?r:i;return t.put(B.name,{meta:e,updatedAt:i,createdAt:n},String(e.id))}).catch(t=>{this.logger.error(t,{message:"ArtistsStore put",data:{artistId:e.id}})})}async get(e){return this.executeTransaction(async t=>{var r;let a=await t.get(B.name,e);return null!==(r=null==a?void 0:a.meta)&&void 0!==r?r:null}).catch(t=>{this.logger.error(t,{message:"ArtistsStore get",data:{artistId:e}})})}async delete(e){return this.executeTransaction(async t=>t.delete(B.name,e)).catch(t=>{this.logger.error(t,{message:"ArtistsStore delete",data:{artistId:e}})})}constructor({logger:e}){super({config:B,logger:e,handlers:{onUpgrade:e=>{e.createObjectStore(B.name)}}})}}let W={name:v.ARTISTS_TRACKS,version:1,restrictions:{attemptsCount:3}},H="artistId",V="trackId",G=(e,t)=>"".concat(e,":").concat(t);class q extends x{async put(e){let{trackId:t,artistId:r}=e;return this.executeTransaction(async a=>a.put(W.name,e,G(t,r))).catch(e=>{this.logger.error(e,{message:"ArtistsTracksStore put",data:{trackId:t,artistId:r}})})}async getArtistsByTrackId(e){return this.executeTransaction(async t=>(await t.getAllFromIndex(W.name,V,e)).sort((e,t)=>e.artistIndex-t.artistIndex)).catch(t=>{this.logger.error(t,{message:"ArtistsTracksStore getArtistsByTrackId",data:{trackId:e}})})}async delete(e,t){return this.executeTransaction(async r=>r.delete(W.name,G(e,t))).catch(r=>{this.logger.error(r,{message:"ArtistsTracksStore delete",data:{trackId:e,artistId:t}})})}async getCountByArtist(e){return this.executeTransaction(async t=>t.countFromIndex(W.name,H,e)).catch(t=>{this.logger.error(t,{message:"ArtistsTracksStore getCountByArtist",data:{artistId:e}})})}constructor({logger:e}){super({config:W,logger:e,handlers:{onUpgrade:e=>{let t=e.createObjectStore(W.name);t.createIndex(V,"trackId"),t.createIndex(H,"artistId")}}})}}let z={name:v.RESPONSE_CACHE,version:1,restrictions:{attemptsCount:3,count:100}},Y="priority_updatedAt",Q=(e,t)=>"".concat(e,":").concat(t);class J extends x{async put(e){let{uid:t,requestId:r}=e;return this.executeTransaction(async a=>{var i;let n=await this.get(t,r),s=Date.now(),o=null!==(i=null==n?void 0:n.createdAt)&&void 0!==i?i:s,c={...e,updatedAt:s,createdAt:o},l=await a.count(z.name);return n||l<Number(z.restrictions.count)||await this.deleteResponseByLowPriority(),a.put(z.name,c,Q(t,r))}).catch(e=>{this.logger.error(e,{message:"ResponseCacheStore put",data:{requestId:r}})})}async get(e,t,r){let a=await this.getResponse(e,t);return a&&r&&Date.now()-a.updatedAt>r?(await this.delete(e,t),null):null!=a?a:null}async getResponse(e,t){return this.executeTransaction(async r=>{let a=Q(e,t),i=await r.get(z.name,a);return null!=i?i:null}).catch(e=>{this.logger.error(e,{message:"ResponseCacheStore getReponse",data:{requestId:t}})})}async delete(e,t){return this.executeTransaction(async r=>r.delete(z.name,Q(e,t))).catch(e=>{this.logger.error(e,{message:"ResponseCacheStore delete",data:{requestId:t}})})}async deleteResponseByLowPriority(){return this.executeTransaction(async e=>{let t=e.transaction([z.name],"readwrite").objectStore(z.name).index(Y),r=await t.openCursor();return null==r?void 0:r.delete()}).catch(e=>{this.logger.error(e,{message:"ResponseCacheStore deleteResponseByLowPriority"})})}constructor({logger:e}){super({config:z,logger:e,handlers:{onUpgrade:e=>{e.createObjectStore(z.name).createIndex(Y,["priority","updatedAt"])}}})}}let X={name:v.TRACKS,version:1,restrictions:{attemptsCount:3,count:100}};class Z extends x{async put(e){return this.executeTransaction(async t=>{var r;let a=await t.get(X.name,e.id),i=Date.now(),n=null!==(r=null==a?void 0:a.createdAt)&&void 0!==r?r:i;return t.put(X.name,{meta:e,updatedAt:i,createdAt:n},e.id)}).catch(t=>{this.logger.error(t,{message:"TracksStore put",data:{trackId:e.id}})})}async get(e){return this.executeTransaction(async t=>{let r=await t.get(X.name,e);return null!=r?r:null}).catch(t=>{this.logger.error(t,{message:"TracksStore get",data:{trackId:e}})})}async getAllIds(){return this.executeTransaction(async e=>e.getAllKeys(X.name)).catch(e=>{this.logger.error(e,{message:"TracksStore getAllIds"})})}async putDecryptKey(e,t){return this.executeTransaction(async r=>{var a;let i=await r.get(X.name,e);if(!i)return;let n=Date.now(),s=null!==(a=null==i?void 0:i.createdAt)&&void 0!==a?a:n;return r.put(X.name,{meta:i.meta,decryptKey:t,updatedAt:n,createdAt:s},e)}).catch(t=>{this.logger.error(t,{message:"TracksStore putDecryptKey",data:{trackId:e}})})}async putTrackAvailable(e,t){return this.executeTransaction(async r=>{var a;let i=await r.get(X.name,e);if(!i)return;let n=Date.now(),s=null!==(a=null==i?void 0:i.createdAt)&&void 0!==a?a:n,{meta:o}=i;return r.put(X.name,{...i,meta:{...o,available:t},updatedAt:n,createdAt:s},e)}).catch(r=>{this.logger.error(r,{message:"TracksStore putTrackAvailable",data:{trackId:e,available:t}})})}async getDecryptKey(e){return this.executeTransaction(async t=>{var r;let a=await t.get(X.name,e);return null!==(r=null==a?void 0:a.decryptKey)&&void 0!==r?r:null})}async delete(e){return this.executeTransaction(async t=>t.delete(X.name,e)).catch(t=>{this.logger.error(t,{message:"TracksStore delete",data:{trackId:e}})})}constructor({logger:e}){super({config:X,logger:e,handlers:{onUpgrade:e=>{e.createObjectStore(X.name)}}})}}let $={name:v.USERS,version:1,restrictions:{attemptsCount:3,count:100}};class ee extends x{async put(e){return this.executeTransaction(async t=>{var r;let a=await t.get($.name,e.uid),i=Date.now(),n=null!==(r=null==a?void 0:a.createdAt)&&void 0!==r?r:i;return t.put($.name,{...e,updatedAt:i,createdAt:n},e.uid)}).catch(t=>{this.logger.error(t,{message:"UsersStore put",data:{userUid:e.uid}})})}async get(e){return this.executeTransaction(async t=>{let r=await t.get($.name,e);return null!=r?r:null}).catch(t=>{this.logger.error(t,{message:"UsersStore get",data:{uid:e}})})}async delete(e){return this.executeTransaction(async t=>t.delete($.name,e)).catch(t=>{this.logger.error(t,{message:"UsersStore delete",data:{uid:e}})})}constructor({logger:e}){super({config:$,logger:e,handlers:{onUpgrade:e=>{e.createObjectStore($.name)}}})}}var et=r(18796);let er={name:v.USERS_TRACKS,version:1,restrictions:{attemptsCount:3}},ea="trackId",ei=(e,t)=>"".concat(e,":").concat(t);class en extends x{async put(e){let{uid:t,trackId:r}=e;return this.executeTransaction(async a=>{var i;let n=ei(t,r),s=await a.get(er.name,n),o=Date.now(),c=null!==(i=null==s?void 0:s.createdAt)&&void 0!==i?i:o;return a.put(er.name,{...e,updatedAt:o,createdAt:c},n)}).catch(e=>{this.logger.error(e,{message:"UsersTracksStore put",data:{uid:t,trackId:r}})})}async get(e,t){return this.executeTransaction(async r=>{let a=await r.get(er.name,ei(e,t));return null!=a?a:null}).catch(r=>{this.logger.error(r,{message:"UsersTracksStore get",data:{uid:e,trackId:t}})})}async getTracksByUid(e){return this.executeTransaction(async t=>(await t.getAllFromIndex(er.name,"uid",e)).sort((e,t)=>t.createdAt-e.createdAt).map(e=>{let{trackId:t,albumId:r}=e;return String((0,et.i)(t,r))})).catch(t=>{this.logger.error(t,{message:"UsersTracksStore getTracksByUid",data:{uid:e}})})}async delete(e,t){return this.executeTransaction(async r=>r.delete(er.name,ei(e,t))).catch(r=>{this.logger.error(r,{message:"UsersTracksStore delete",data:{uid:e,trackId:t}})})}async getCountByTrackId(e){return this.executeTransaction(async t=>t.countFromIndex(er.name,ea,e)).catch(t=>{this.logger.error(t,{message:"UsersTracksStore getCountByTrackId",data:{trackId:e}})})}constructor({logger:e}){super({config:er,logger:e,handlers:{onUpgrade:e=>{let t=e.createObjectStore(er.name);t.createIndex("uid","uid"),t.createIndex(ea,"trackId")}}})}}let es=e=>{let{useFileStorage:t,useResponseCacheStorage:r,useEntitiesStorage:a,logger:i}=e,n={};return t&&(n.fileStorage=new _({logger:i})),r&&(n.responseCacheStore=new J({logger:i})),a&&(n.albumsStore=new L({logger:i}),n.albumsTracksStore=new K({logger:i}),n.artistsStore=new M({logger:i}),n.artistsTracksStore=new q({logger:i}),n.tracksStore=new Z({logger:i}),n.usersStore=new ee({logger:i}),n.usersTracksStore=new en({logger:i})),n};class eo{init(e){var t;let{userConfig:r}=e;this.userConfig=r,null===(t=this.storeContainer.usersStore)||void 0===t||t.put({uid:r.uid})}setTracks(e){this.tracks=e}setPlaylists(e){this.playlists=e}async clearAll(){var e,t,r,a,i,n,s,o;return Promise.all([null===(e=this.storeContainer.fileStorage)||void 0===e?void 0:e.clearAll(),null===(t=this.storeContainer.albumsStore)||void 0===t?void 0:t.clearAll(),null===(r=this.storeContainer.albumsTracksStore)||void 0===r?void 0:r.clearAll(),null===(a=this.storeContainer.artistsStore)||void 0===a?void 0:a.clearAll(),null===(i=this.storeContainer.artistsTracksStore)||void 0===i?void 0:i.clearAll(),null===(n=this.storeContainer.tracksStore)||void 0===n?void 0:n.clearAll(),null===(s=this.tracks)||void 0===s?void 0:s.clearAll(),null===(o=this.storeContainer.usersTracksStore)||void 0===o?void 0:o.clearAll()])}constructor(e){(0,w._)(this,"network",new I),(0,w._)(this,"storeContainer",void 0),(0,w._)(this,"config",void 0),(0,w._)(this,"userConfig",null),(0,w._)(this,"tracks",null),(0,w._)(this,"playlists",null),this.config=e,this.storeContainer=es(this.config)}}var ec=r(13307);(n=g||(g={})).TRACK="track",n.ENTITY="entity";var el=r(44539),eu=r(36301),ed=r(61605);(s=y||(y={})).TRACK_META_RECEIVED="track_meta_received",s.TRACK_DECRYPT_KEY_RECEIVED="track_decrypt_key_received",s.CHUNK_MEDIA_FILE_RECEIVED="chunk_media_file_received",s.TRACK_IMAGE_RECEIVED="track_image_received",s.TRACK_DOWNLOAD_FINISHED="track_download_finished",s.TRACK_DOWNLOAD_STOPPED="track_download_stopped",s.TRACK_DOWNLOAD_FAILED="track_download_failed";class eh{async getFileInfo(e,t){let r=(0,eu.I)(),a=this.variables.codecs.join(""),i="".concat(r).concat(e).concat(t).concat(a).concat(this.transport),n=await (0,eu.U)({secretKey:this.secretKey,data:i});return this.getFileInfoResource.getFileInfo({tsInSeconds:r,trackId:e,quality:t,codecs:this.variables.codecs,transports:[this.transport],sign:n})}async getTrackImage(e,t){let r=(0,el.zp)(t,this.variables.coverSize,!1),a=await fetch(r),i=await a.blob();this.events.emit(y.TRACK_IMAGE_RECEIVED,e,i)}async start(){try{let[e]=await this.tracksResource.getTracksMeta({trackIds:[this.id]});if(!e||!e.available)return;let t=String(e.id);this.events.emit(y.TRACK_META_RECEIVED,e),e.coverUri&&this.getTrackImage(this.id,e.coverUri);let{downloadInfo:r}=await this.getFileInfo(t,this.variables.quality);if("error"in r||r.transport!==ed.J.ENCRAW)return;this.events.emit(y.TRACK_DECRYPT_KEY_RECEIVED,t,r.key);let a=null,i=0,n=r.urls[0];if(!n)return;let s=async()=>{if(this.isStopped)return;let e=0;null===a||i+this.variables.chunkSize<a?e=i+this.variables.chunkSize-1:i+this.variables.chunkSize>=a&&(e=a);let{contentLength:r,data:o,contentRange:c}=await this.getFileInfoResource.getByteRange({srcUrl:n,start:i,end:e});i+=r,a=Number(c.split("/")[1]),this.events.emit(y.CHUNK_MEDIA_FILE_RECEIVED,t,{data:o,progress:Math.floor(i/a*100)}),null!==a&&i<a&&await s()};await s(),i===a?this.events.emit(y.TRACK_DOWNLOAD_FINISHED,this.id):this.events.emit(y.TRACK_DOWNLOAD_STOPPED,this.id)}catch(e){("string"==typeof e||e instanceof Error)&&this.logger.error(e,{message:"Error downloading track",data:{trackId:this.id}}),this.events.emit(y.TRACK_DOWNLOAD_FAILED,this.id)}}stop(){this.isStopped=!0}constructor(e,t){(0,w._)(this,"id",void 0),(0,w._)(this,"isStopped",!1),(0,w._)(this,"tracksResource",void 0),(0,w._)(this,"getFileInfoResource",void 0),(0,w._)(this,"secretKey",void 0),(0,w._)(this,"transport",void 0),(0,w._)(this,"variables",void 0),(0,w._)(this,"logger",void 0),(0,w._)(this,"events",new S.Q),this.id=e,this.tracksResource=t.tracksResource,this.getFileInfoResource=t.getFileInfoResource,this.secretKey=t.secretKey,this.transport=t.transport,this.variables=t.variables,this.events=t.events,this.logger=t.logger}}(o=m||(m={})).IDLE="IDLE",o.DOWNLOADING="DOWNLOADING",o.DOWNLOADED="DOWNLOADED",o.DOWNLOAD_FAILED="DOWNLOAD_FAILED",o.REMOVING="REMOVING";let ev=async e=>{var t;let{trackId:r,storeContainer:a}=e,i=await (null===(t=a.albumsTracksStore)||void 0===t?void 0:t.getAlbumsByTrackId(r));null==i||i.forEach(async e=>{var t,i,n;await (null===(t=a.albumsTracksStore)||void 0===t?void 0:t.delete(r,e)),0===await (null===(i=a.albumsTracksStore)||void 0===i?void 0:i.getCountByAlbum(e))&&(null===(n=a.albumsStore)||void 0===n||n.delete(e))})},eg=async e=>{var t;let{trackId:r,storeContainer:a}=e,i=await (null===(t=a.artistsTracksStore)||void 0===t?void 0:t.getArtistsByTrackId(r));null==i||i.forEach(async e=>{var t,i,n;let{artistId:s}=e;await (null===(t=a.artistsTracksStore)||void 0===t?void 0:t.delete(r,s)),0===await (null===(i=a.artistsTracksStore)||void 0===i?void 0:i.getCountByArtist(s))&&(null===(n=a.artistsStore)||void 0===n||n.delete(s))})},ey=e=>"images/tracks/".concat(e),em=async e=>{var t,r;let{trackId:a,albumId:i,storeContainer:n}=e,s=[];if(i){let e=await (null===(t=n.albumsStore)||void 0===t?void 0:t.get(i));e&&s.push({...e,artists:[]})}else{let e=await (null===(r=n.albumsTracksStore)||void 0===r?void 0:r.getAlbumsByTrackId(a));if(!(null==e?void 0:e.length))return s;(await Promise.all(e.map(async e=>n.albumsStore?n.albumsStore.get(e):null))).forEach(e=>{e&&s.push({...e,artists:[]})})}return s},eb=e=>"object"==typeof e&&"id"in e,ef=async e=>{var t;let r,{trackId:a,storeContainer:i}=e,n=await (null===(t=i.artistsTracksStore)||void 0===t?void 0:t.getArtistsByTrackId(a));if(!(null==n?void 0:n.length))return[];let s=await Promise.all(n.map(async e=>{var t;let{artistId:r}=e;return null===(t=i.artistsStore)||void 0===t?void 0:t.get(r)})),o=[];return n.forEach((e,t)=>{let{decomposed:a,prefix:i}=e,n=s[t];if(n){if(!a&&eb(n)){r=n,o.push(n);return}r&&(void 0===r.decomposed&&(r.decomposed=[]),i&&r.decomposed.push(i),r.decomposed.push(n))}}),o},ep=e=>"tracks/".concat(e),ew=e=>{var t;let{track:r,storeContainer:a}=e;null===(t=r.albums)||void 0===t||t.forEach(async e=>{var t,i;let{artists:n,...s}=e;await Promise.all([null===(t=a.albumsStore)||void 0===t?void 0:t.put(s),null===(i=a.albumsTracksStore)||void 0===i?void 0:i.put(String(r.id),String(s.id))])})},eS=e=>{var t;let{track:r,storeContainer:a}=e,i=0;if(!r.artists)return;let n=[];null===(t=r.artists)||void 0===t||t.forEach(e=>{let{decomposed:t,...a}=e;n.push({artistMeta:a,artistTrack:{artistId:String(e.id),trackId:String(r.id),artistIndex:i}}),i++;let s="";t&&t.length>0&&t.forEach(e=>{if("string"==typeof e){s=e;return}n.push({artistMeta:e,artistTrack:{artistId:String(e.id),trackId:String(r.id),artistIndex:i,decomposed:!0,prefix:s}}),i++,s=""})}),n.forEach(async e=>{var t,r;let{artistMeta:i,artistTrack:n}=e;await Promise.all([null===(t=a.artistsStore)||void 0===t?void 0:t.put(i),null===(r=a.artistsTracksStore)||void 0===r?void 0:r.put(n)])})};(c=b||(b={})).TRACK_CHANGED="track_changed",c.STATE_CHANGED="state_changed";let eT=[m.IDLE,m.DOWNLOAD_FAILED],ek=[m.IDLE,m.DOWNLOADING];class eA{async initTracksState(){try{var e;let t=await (null===(e=this.storeContainer.usersTracksStore)||void 0===e?void 0:e.getTracksByUid(this.userConfig.uid));(null==t?void 0:t.length)&&(this.state=t.reduce((e,t)=>{let[r]=(0,et.f)(t);return r&&(e[r]={loadingState:m.DOWNLOADED}),e},{})),this.events.emit(b.STATE_CHANGED,this.state)}catch(e){("string"==typeof e||e instanceof Error)&&this.logger.error(e,{message:"Failed to init tracks state"})}}async validateTracks(){try{var e;let t=await (null===(e=this.storeContainer.tracksStore)||void 0===e?void 0:e.getAllIds());t&&t.forEach(async e=>{var t;let r=String(e),a=await (null===(t=this.storeContainer.usersTracksStore)||void 0===t?void 0:t.getCountByTrackId(r));0===a&&this.deleteTrack(r)})}catch(e){("string"==typeof e||e instanceof Error)&&this.logger.error(e,{message:"Failed to validate tracks"})}}download(e){var t;let[r]=(0,et.f)(e);if(!r)return;let a=null===(t=this.state[r])||void 0===t?void 0:t.loadingState;(!this.state[r]||a&&eT.includes(a))&&this.downloader.injectTask(new eh(String(e),this.trackDownloadTaskParams))}stopDownload(e){var t;let[r]=(0,et.f)(e);if(!r)return;let a=null===(t=this.state[r])||void 0===t?void 0:t.loadingState;(!this.state[r]||a&&ek.includes(a))&&(this.changeState(r,{loadingState:m.IDLE}),this.downloader.removeTask(String(e)))}clearAll(){this.state={},this.events.emit(b.STATE_CHANGED,this.state)}async getTracks(){var e;let t=await (null===(e=this.storeContainer.usersTracksStore)||void 0===e?void 0:e.getTracksByUid(this.userConfig.uid));return t?(await Promise.all(null==t?void 0:t.map(async e=>this.getTrack(e)))).filter(e=>null!==e):[]}async getTrack(e){var t,r;let[a,i]=(0,et.f)(e);if(!a)return null;let n=await (null===(t=this.storeContainer.tracksStore)||void 0===t?void 0:t.get(a));if(!n)return null;let s=n.meta;if(s.coverUri)try{s.coverUri=await (null===(r=this.storeContainer.fileStorage)||void 0===r?void 0:r.createFileURL(ey(e)))}catch(t){("string"==typeof t||t instanceof Error)&&this.logger.error(t,{message:"Failed to create file URL",data:{id:e}})}return s.albums=await em({trackId:String(s.id),albumId:i,storeContainer:this.storeContainer}),s.artists=await ef({trackId:String(s.id),storeContainer:this.storeContainer}),s}async deleteTrack(e){try{var t,r,a,i,n;let[s]=(0,et.f)(e);if(!s)return;await (null===(t=this.storeContainer.usersTracksStore)||void 0===t?void 0:t.delete(this.userConfig.uid,s)),this.changeState(s,{loadingState:m.IDLE});let o=await (null===(r=this.storeContainer.usersTracksStore)||void 0===r?void 0:r.getCountByTrackId(s));if(0!==o)return;await Promise.all([null===(a=this.storeContainer.fileStorage)||void 0===a?void 0:a.deleteFile(ep(s)),null===(i=this.storeContainer.fileStorage)||void 0===i?void 0:i.deleteFile(ey(e)),null===(n=this.storeContainer.tracksStore)||void 0===n?void 0:n.delete(s),ev({trackId:s,storeContainer:this.storeContainer}),eg({trackId:s,storeContainer:this.storeContainer})])}catch(t){("string"==typeof t||t instanceof Error)&&this.logger.error(t,{message:"Failed to delete track",data:{id:e}})}}async refreshTracksAvailability(){try{var e;let t=await (null===(e=this.storeContainer.usersTracksStore)||void 0===e?void 0:e.getTracksByUid(this.userConfig.uid));if(!t)return;let r=async e=>{(await this.availabilityResource.getAvailabilityTracks({trackIds:e})).availabilities.forEach(e=>{let{trackId:t,available:r}=e,[a]=(0,et.f)(t);if(a){var i;null===(i=this.storeContainer.tracksStore)||void 0===i||i.putTrackAvailable(a,r)}})},a=(0,ec.Z)(t,this.variables.requestTrackChunkSize);Promise.all(a.map(r))}catch(e){("string"==typeof e||e instanceof Error)&&this.logger.error(e,{message:"Failed to refresh tracks availability"})}}async refreshTracksMeta(){try{var e;let t=await (null===(e=this.storeContainer.usersTracksStore)||void 0===e?void 0:e.getTracksByUid(this.userConfig.uid));if(!t)return;let r=async e=>{(await this.tracksResource.getTracksMeta({trackIds:e})).forEach(this.updateTrackMeta.bind(this))},a=(0,ec.Z)(t,this.variables.requestTrackChunkSize);Promise.all(a.map(r))}catch(e){("string"==typeof e||e instanceof Error)&&this.logger.error(e,{message:"Failed to refresh tracks meta"})}}async updateTrackMeta(e){try{var t,r,a,i,n;let s=await (null===(t=this.storeContainer.usersTracksStore)||void 0===t?void 0:t.get(this.userConfig.uid,String(e.id)));if(!s)return;if(s.albumId===String(null===(a=e.albums)||void 0===a?void 0:null===(r=a[0])||void 0===r?void 0:r.id)){await eg({trackId:String(e.id),storeContainer:this.storeContainer}),this.saveTrackMeta(e);return}await this.deleteTrack(String((0,et.i)(s.trackId,s.albumId))),this.download(String((0,et.i)(e.id,null===(n=e.albums)||void 0===n?void 0:null===(i=n[0])||void 0===i?void 0:i.id)))}catch(t){("string"==typeof t||t instanceof Error)&&this.logger.error(t,{message:"Failed to update track meta",data:{trackId:e.id}})}}saveTrackMeta(e){var t;ew({track:e,storeContainer:this.storeContainer}),eS({track:e,storeContainer:this.storeContainer}),delete e.albums,delete e.artists,null===(t=this.storeContainer.tracksStore)||void 0===t||t.put(e)}onTrackMetaReceived(e){this.changeState(String(e.id),{loadingState:m.DOWNLOADING}),this.saveTrackMeta(e)}onTrackDownloadFinished(e){var t;let[r,a]=(0,et.f)(e);r&&(null===(t=this.storeContainer.usersTracksStore)||void 0===t||t.put({uid:this.userConfig.uid,downloadSource:g.TRACK,trackId:r,albumId:a}),this.changeState(r,{loadingState:m.DOWNLOADED}))}onTrackDownloadStopped(e){let[t]=(0,et.f)(e);t&&(this.deleteTrack(e),this.changeState(t,{loadingState:m.IDLE}))}onTrackDecryptKeyReceived(e,t){var r;null===(r=this.storeContainer.tracksStore)||void 0===r||r.putDecryptKey(e,t)}onTrackDownloadFailed(e){let[t]=(0,et.f)(e);t&&(this.deleteTrack(e),this.changeState(t,{loadingState:m.DOWNLOAD_FAILED}))}onTrackImageReceived(e,t){var r;null===(r=this.storeContainer.fileStorage)||void 0===r||r.writeFile(ey(e),t)}onChunkMediaFileReceived(e,t){var r,a;let{data:i,progress:n}=t;(null===(r=this.state[e])||void 0===r?void 0:r.loadingState)!==m.IDLE&&(null===(a=this.storeContainer.fileStorage)||void 0===a||a.appendFile(ep(e),i),this.changeState(e,{loadingState:m.DOWNLOADING,progress:n}))}changeState(e,t){this.state[e]=t,this.events.emit(b.TRACK_CHANGED,{trackId:e,state:t})}constructor(e){(0,w._)(this,"userConfig",void 0),(0,w._)(this,"downloader",void 0),(0,w._)(this,"storeContainer",void 0),(0,w._)(this,"trackDownloadTaskParams",void 0),(0,w._)(this,"availabilityResource",void 0),(0,w._)(this,"tracksResource",void 0),(0,w._)(this,"variables",void 0),(0,w._)(this,"logger",void 0),(0,w._)(this,"state",{}),(0,w._)(this,"events",new S.Q),this.userConfig=e.userConfig,this.downloader=e.downloader,this.storeContainer=e.storeContainer,this.trackDownloadTaskParams=e.trackDownloadTaskParams,this.availabilityResource=e.availabilityResource,this.tracksResource=e.tracksResource,this.variables=e.variables,this.logger=e.logger,this.validateTracks(),this.downloader.events.on(y.TRACK_META_RECEIVED,this.onTrackMetaReceived.bind(this)),this.downloader.events.on(y.TRACK_DECRYPT_KEY_RECEIVED,this.onTrackDecryptKeyReceived.bind(this)),this.downloader.events.on(y.CHUNK_MEDIA_FILE_RECEIVED,this.onChunkMediaFileReceived.bind(this)),this.downloader.events.on(y.TRACK_IMAGE_RECEIVED,this.onTrackImageReceived.bind(this)),this.downloader.events.on(y.TRACK_DOWNLOAD_FINISHED,this.onTrackDownloadFinished.bind(this)),this.downloader.events.on(y.TRACK_DOWNLOAD_STOPPED,this.onTrackDownloadStopped.bind(this)),this.downloader.events.on(y.TRACK_DOWNLOAD_FAILED,this.onTrackDownloadFailed.bind(this))}}(l=f||(f={}))[l.LOW=1]="LOW",l[l.MEDIUM=2]="MEDIUM",l[l.HIGH=3]="HIGH",(u=p||(p={})).DEFAULT="E_RESOURCE_PROXY",u.CACHE_NOT_FOUND="E_RESOURCE_PROXY_CACHE_NOT_FOUND",u.UID_NOT_FOUND="E_RESOURCE_PROXY_UID_NOT_FOUND";class eE extends C.y{constructor(e="Resource proxy error",{code:t=p.DEFAULT,...r}={}){super(e,{code:t,...r}),(0,w._)(this,"name","ResourceProxyException"),Object.setPrototypeOf(this,eE.prototype)}}let eI=async(e,t)=>{let{uid:r,requestId:a,ttl:i}=t,n=await e.get(r,a,i);if(n)return n.response;throw new eE("Cache not found",{code:p.CACHE_NOT_FOUND,data:{uid:r,requestId:a}})},eC=(e,t)=>{var r,a,i,n;let s=null===(r=e.overrides)||void 0===r?void 0:r[t];return{enabled:null!==(a=null==s?void 0:s.enabled)&&void 0!==a?a:e.enabled,ttl:null!==(i=null==s?void 0:s.ttl)&&void 0!==i?i:e.ttl,priority:null!==(n=null==s?void 0:s.priority)&&void 0!==n?n:e.priority}};var eD=r(23874);let e_=async(e,t,r)=>{let{uid:a,requestId:i,ttl:n}=r;if(!a)throw new eE("Uid not found",{code:p.UID_NOT_FOUND,data:{requestId:i}});if(!(e instanceof eD.du)||e.statusCode===eD.CN.REQUEST_TIMEOUT)return eI(t,{uid:a,requestId:i,ttl:n});throw e},eR=(e,t,r)=>new Proxy(e,{get(e,a){let i=e[a],{enabled:n,ttl:s,priority:o}=eC(r,a);return"function"==typeof i&&n?async function(){for(var n=arguments.length,c=Array(n),l=0;l<n;l++)c[l]=arguments[l];let{uid:u,resourceName:d,isOffline:h}=r.common,v=[d,a,...c].join("-");if(h&&u)return eI(t,{uid:u,requestId:v,ttl:s});switch(a){case"experiments":case"experimentsDetails":case"settings":try{let r=await i.apply(e,c);return u&&t.put({uid:u,requestId:v,priority:null!=o?o:f.LOW,response:r}),r}catch(e){return e_(e,t,{uid:u,requestId:v,ttl:s})}case"about":try{let r=await i.apply(e,c);return t.put({uid:r.uid,requestId:v,priority:null!=o?o:f.LOW,response:r}),r}catch(e){return e_(e,t,{uid:u,requestId:v,ttl:s})}default:return i.apply(e,c)}}:i}});var eO=r(77900);let ex=e=>new Uint8Array(e.match(/.{1,2}/g).map(e=>parseInt(e,16))),eF=e=>{let t=e,r=new Uint8Array(16);for(let e=0;e<16;++e)r[r.length-1-e]=255&t,t>>=8;return r},eL=async e=>{let{key:t,data:r,loadedBytes:a}=e,i=await crypto.subtle.importKey("raw",ex(t),{name:"AES-CTR"},!1,["encrypt","decrypt"]),n=new Uint8Array(16);return a&&(n=eF(a/16)),crypto.subtle.decrypt({name:"AES-CTR",counter:n,length:128},i,r)},eP=e=>"object"==typeof e&&null!==e&&"trackId"in e,ej=[eO.n.PREVIEW,eO.n.SMART_PREVIEW],eU=async e=>{let{target:t,args:r,method:a,fileStorage:i,tracksStore:n,userTracksStore:s,uid:o,logger:c}=e,l=r[0];if(!eP(l)||ej.includes(l.quality))return a.apply(t,r);let u=!1;try{let{trackId:e}=l;if(!await s.get(o,String(e)))throw new eE("Track not found");u=!0;let t=await n.getDecryptKey(String(e));if(!t)throw new eE("Decrypt key not found");let r=await i.readFile(ep(String(e))),a=r.slice(0,r.size),c=await a.arrayBuffer(),d=await eL({data:c,key:t});return{downloadInfo:{urls:[URL.createObjectURL(new Blob([d]))]}}}catch(e){return u&&("string"==typeof e||e instanceof Error)&&c.error(e,{message:"Error getting local media file"}),a.apply(t,r)}},eN=(e,t)=>{let{fileStorage:r,tracksStore:a,userTracksStore:i,uid:n,logger:s}=t;return new Proxy(e,{get(e,t){let o=e[t];return"function"==typeof o?async function(){for(var c=arguments.length,l=Array(c),u=0;u<c;u++)l[u]=arguments[u];return"getFileInfo"===t?eU({target:e,method:o,args:l,fileStorage:r,tracksStore:a,userTracksStore:i,uid:n,logger:s}):o.apply(e,l)}:o}})}}}]);